# Complete Deployment Guide - HS Code Classifier

## Overview
This guide walks you through deploying both the backend (Railway) and frontend (Vercel) to production.

**Estimated Time**: 30-45 minutes
**Cost**: Free tier available for both platforms

---

## Prerequisites

Before starting, ensure you have:

- [x] Git repository with latest code committed
- [x] GitHub account
- [x] OpenAI API key (from https://platform.openai.com/api-keys)
- [ ] Railway account (create at https://railway.app)
- [ ] Vercel account (create at https://vercel.com)
- [ ] PostgreSQL database (Railway provides this automatically)

---

## Part 1: Deploy Backend to Railway (20 minutes)

### Step 1: Create Railway Account

1. Go to https://railway.app
2. Click "Start a New Project"
3. Sign in with GitHub
4. Authorize Railway to access your repositories

### Step 2: Create New Project

1. Click "New Project"
2. Select "Deploy from GitHub repo"
3. Choose `hs-code-classifier` repository
4. Select the `backend` directory as root
5. Railway will automatically detect Node.js

### Step 3: Add PostgreSQL Database

1. In your Railway project dashboard
2. Click "+ New" â†’ "Database" â†’ "PostgreSQL"
3. Railway will automatically create a PostgreSQL instance
4. Database URL will be auto-generated

### Step 4: Configure Environment Variables

In Railway dashboard, go to your backend service â†’ "Variables":

Add the following variables:

```env
# Database (auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# OpenAI API Key (get from https://platform.openai.com/api-keys)
OPENAI_API_KEY=sk-your-actual-openai-api-key

# Server Configuration
PORT=3001
NODE_ENV=production

# CORS - Update after deploying frontend
CORS_ORIGIN=http://localhost:3000,https://your-frontend.vercel.app
```

**IMPORTANT**:
- `DATABASE_URL` should reference the PostgreSQL service: `${{Postgres.DATABASE_URL}}`
- Get your OpenAI API key from: https://platform.openai.com/api-keys
- You'll update `CORS_ORIGIN` after deploying the frontend

### Step 5: Configure Build & Deploy

Railway should auto-detect the build command, but verify:

**Build Command**:
```bash
npm install && npm run prisma:generate && npm run build
```

**Start Command**:
```bash
npm run prisma:push && npm run prisma:seed && npm start
```

### Step 6: Deploy Backend

1. Click "Deploy" in Railway dashboard
2. Wait for build to complete (~3-5 minutes)
3. Monitor the deployment logs for errors
4. Once deployed, Railway will provide a public URL

### Step 7: Get Your Backend URL

1. In Railway dashboard, click on your backend service
2. Go to "Settings" â†’ "Networking"
3. Click "Generate Domain"
4. Your backend URL will be something like: `https://hs-code-classifier-production.up.railway.app`

**Save this URL - you'll need it for the frontend!**

### Step 8: Test Backend API

```bash
# Replace with your actual Railway URL
curl https://your-backend.railway.app/api/health

# Should return:
# {"status":"ok","timestamp":"...","uptime":...}
```

### Step 9: Verify Database Seeded

Check Railway logs for:
```
âœ… Database seeded successfully!
Seeded 5422 HS codes
```

---

## Part 2: Deploy Frontend to Vercel (15 minutes)

### Step 1: Create Vercel Account

1. Go to https://vercel.com
2. Click "Sign Up"
3. Sign in with GitHub
4. Authorize Vercel to access your repositories

### Step 2: Import Project

1. Click "Add New..." â†’ "Project"
2. Import `hs-code-classifier` repository
3. Vercel will detect it's a monorepo

### Step 3: Configure Project Settings

**Framework Preset**: Next.js
**Root Directory**: `frontend`
**Build Command**: `npm run build` (auto-detected)
**Output Directory**: `.next` (auto-detected)

### Step 4: Add Environment Variables

In Vercel project settings â†’ "Environment Variables":

**Variable**: `NEXT_PUBLIC_API_URL`
**Value**: `https://your-backend.railway.app` (from Part 1, Step 7)
**Environment**: Production, Preview, Development

**IMPORTANT**: Use your actual Railway backend URL!

Example:
```env
NEXT_PUBLIC_API_URL=https://hs-code-classifier-production.up.railway.app
```

### Step 5: Deploy Frontend

1. Click "Deploy"
2. Wait for build to complete (~2-3 minutes)
3. Vercel will provide a deployment URL

### Step 6: Get Your Frontend URL

After deployment, Vercel will show:
```
https://hs-code-classifier.vercel.app
```

Or you can use a custom domain if you have one.

**Save this URL - you need to update backend CORS!**

---

## Part 3: Update Backend CORS (5 minutes)

### Step 1: Update Railway Environment Variables

1. Go back to Railway dashboard
2. Open your backend service
3. Go to "Variables"
4. Update `CORS_ORIGIN`:

```env
CORS_ORIGIN=https://hs-code-classifier.vercel.app,https://your-custom-domain.com
```

**Remove** `http://localhost:3000` if you don't need local development access.

### Step 2: Redeploy Backend

Railway will automatically redeploy when you change environment variables.

Wait for redeployment to complete (~2 minutes).

---

## Part 4: End-to-End Testing (10 minutes)

### Test 1: Frontend Loads

1. Visit your Vercel URL: `https://hs-code-classifier.vercel.app`
2. Check that homepage loads correctly
3. Verify mobile responsive design (Chrome DevTools)

### Test 2: API Connection

1. Open browser DevTools â†’ Network tab
2. Enter a product description: "Steel bolts M8 x 25mm"
3. Submit the form
4. Verify API request goes to Railway backend
5. Check response contains HS code classification

### Test 3: Error Handling

1. Test invalid input (empty form)
2. Test timeout behavior (if backend is slow)
3. Verify error messages display correctly

### Test 4: Mobile Testing

Test on real devices:
- [ ] iPhone/Safari
- [ ] Android/Chrome
- [ ] Tablet (iPad/Android)

Use checklist: `frontend/MOBILE-TEST-CHECKLIST.md`

### Test 5: Performance

Run Lighthouse audit:
```bash
lighthouse https://hs-code-classifier.vercel.app --view
```

**Targets**:
- Performance: > 90
- Accessibility: > 90
- Best Practices: > 90
- SEO: > 90

---

## Troubleshooting

### Backend Issues

**Problem**: Backend won't start
- Check Railway logs for errors
- Verify `DATABASE_URL` is set correctly
- Ensure `OPENAI_API_KEY` is valid

**Problem**: Database connection failed
- Verify PostgreSQL service is running in Railway
- Check `DATABASE_URL` format is correct
- Ensure database service is linked to backend

**Problem**: Prisma seed fails
- Check that `prisma/hs-codes.json` exists
- Verify file path in `seed.ts`
- Check Railway build logs for file inclusion

### Frontend Issues

**Problem**: "Network error" when classifying
- Verify `NEXT_PUBLIC_API_URL` is set correctly
- Check backend CORS allows frontend domain
- Test backend API directly with curl

**Problem**: Build fails on Vercel
- Check `package.json` scripts are correct
- Verify all dependencies are listed
- Check Vercel build logs for TypeScript errors

**Problem**: Environment variable not working
- Ensure variable starts with `NEXT_PUBLIC_`
- Redeploy after adding variables
- Clear Vercel cache and redeploy

### CORS Issues

**Problem**: "CORS policy blocked" error
- Update backend `CORS_ORIGIN` to include frontend URL
- Ensure no trailing slashes in URLs
- Check both `http://` and `https://` if needed

---

## Post-Deployment Checklist

### Backend (Railway)

- [ ] Backend deploys successfully
- [ ] Database connected and seeded
- [ ] Health check endpoint responds: `/api/health`
- [ ] Classification endpoint works: `/api/classify`
- [ ] Logs show no errors
- [ ] Environment variables set correctly

### Frontend (Vercel)

- [ ] Frontend deploys successfully
- [ ] Homepage loads correctly
- [ ] Can submit classification form
- [ ] Results display properly
- [ ] Error handling works
- [ ] Mobile responsive (all devices)
- [ ] Lighthouse score > 90

### Integration

- [ ] Frontend connects to backend
- [ ] CORS configured correctly
- [ ] End-to-end classification works
- [ ] No console errors
- [ ] Performance acceptable (< 5s response)

---

## Monitoring & Maintenance

### Railway Monitoring

1. **Logs**: Railway dashboard â†’ Service â†’ Logs
2. **Metrics**: CPU, Memory, Network usage
3. **Database**: Check connection count, query performance

### Vercel Monitoring

1. **Analytics**: Vercel dashboard â†’ Analytics
2. **Logs**: Vercel dashboard â†’ Deployments â†’ Logs
3. **Performance**: Core Web Vitals tracking

### Cost Monitoring

**Railway Free Tier**:
- $5 free credit per month
- ~500 hours of uptime
- Sufficient for development/testing

**Vercel Free Tier**:
- 100 GB bandwidth per month
- Unlimited deployments
- Perfect for hobby projects

**OpenAI Costs**:
- GPT-4o-mini: $0.15/1M input, $0.60/1M output tokens
- Estimated: $0.001 - $0.003 per classification
- ~$1-3 for 1000 classifications

---

## Environment Variables Reference

### Backend (Railway)

| Variable | Example | Required | Description |
|----------|---------|----------|-------------|
| `DATABASE_URL` | `postgresql://...` | âœ… | Auto-generated by Railway |
| `OPENAI_API_KEY` | `sk-...` | âœ… | From OpenAI platform |
| `PORT` | `3001` | âœ… | Server port |
| `NODE_ENV` | `production` | âœ… | Environment |
| `CORS_ORIGIN` | `https://app.vercel.app` | âœ… | Allowed origins |

### Frontend (Vercel)

| Variable | Example | Required | Description |
|----------|---------|----------|-------------|
| `NEXT_PUBLIC_API_URL` | `https://api.railway.app` | âœ… | Backend URL |

---

## Custom Domain Setup (Optional)

### Add Custom Domain to Vercel

1. Vercel dashboard â†’ Settings â†’ Domains
2. Add your domain: `hscodeclassifier.com`
3. Update DNS records (Vercel provides instructions)
4. Wait for SSL certificate (automatic)

### Add Custom Domain to Railway

1. Railway dashboard â†’ Settings â†’ Networking
2. Add custom domain: `api.hscodeclassifier.com`
3. Update DNS records (Railway provides instructions)
4. Update frontend `NEXT_PUBLIC_API_URL`
5. Update backend `CORS_ORIGIN`

---

## Security Best Practices

### Backend

- [x] Environment variables not committed to Git
- [x] CORS restricted to frontend domain only
- [x] HTTPS enforced (Railway automatic)
- [x] Database credentials secured
- [ ] Rate limiting enabled (TODO: Phase 3)
- [ ] API authentication (TODO: Phase 3)

### Frontend

- [x] API URL configurable via environment
- [x] No secrets in client-side code
- [x] HTTPS enforced (Vercel automatic)
- [ ] Content Security Policy (TODO: Phase 3)
- [ ] Security headers configured (TODO: Phase 3)

---

## Rollback Procedure

### Rollback Frontend (Vercel)

1. Vercel dashboard â†’ Deployments
2. Find previous working deployment
3. Click "..." â†’ "Promote to Production"
4. Immediate rollback (< 1 minute)

### Rollback Backend (Railway)

1. Railway dashboard â†’ Deployments
2. Find previous working deployment
3. Click "Rollback to this version"
4. Wait for redeployment (~2-3 minutes)

---

## Next Steps After Deployment

### Phase 3 Enhancements

1. **Analytics Integration**
   - Google Analytics
   - Plausible Analytics
   - Track classification success rate

2. **Error Tracking**
   - Sentry for error monitoring
   - Real-time alerts
   - Performance tracking

3. **User Feedback**
   - Save feedback to database
   - Admin dashboard to review
   - Improve classification accuracy

4. **Rate Limiting**
   - Prevent API abuse
   - Protect OpenAI budget
   - Fair usage policies

5. **Caching**
   - Cache common classifications
   - Reduce OpenAI API calls
   - Improve response time

---

## Support & Resources

### Documentation

- [Railway Docs](https://docs.railway.app)
- [Vercel Docs](https://vercel.com/docs)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [Prisma Production](https://www.prisma.io/docs/guides/deployment)

### Getting Help

- Railway Discord: https://discord.gg/railway
- Vercel Discord: https://discord.gg/vercel
- GitHub Issues: Create issue in your repository

---

## Deployment Completion

Once all tests pass, your application is live! ðŸŽ‰

**URLs to share**:
- Frontend: `https://hs-code-classifier.vercel.app`
- Backend API: `https://hs-code-classifier-production.up.railway.app`
- API Health: `https://your-backend.railway.app/api/health`

**Next Steps**:
1. Share with beta testers
2. Collect feedback
3. Monitor performance and costs
4. Iterate and improve

---

*Last Updated: November 23, 2024*
*Status: Production Deployment Guide*
