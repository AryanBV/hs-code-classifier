# HS Code Data Processing

This directory contains scripts and data for processing HS code classifications.

---

## Overview

**Phase 0 Workflow:**
1. **Day 1:** Manually classify 20 products using ICEGATE
2. **Day 2:** Fill `test_dataset.csv` with your classifications
3. **Days 3-4:** Run `scraper.py` to structure data for database import
4. **Days 3-4:** Import structured data into PostgreSQL via Prisma

---

## Files

| File | Purpose | Status |
|------|---------|--------|
| `scraper.py` | Process CSV ‚Üí JSON for database import | ‚úÖ Ready |
| `test_dataset.csv` | Your 20 manually classified products | ‚è≥ To be filled |
| `requirements.txt` | Python dependencies | ‚úÖ Ready |
| `hs_codes_seed.json` | Output file (auto-generated) | ‚è≥ Generated by script |

---

## Setup

### 1. Install Python Dependencies

```bash
cd data
pip install -r requirements.txt
```

Or with conda:
```bash
conda create -n hs-classifier python=3.9
conda activate hs-classifier
pip install -r requirements.txt
```

---

## Phase 0 - Day 1: Manual Classification

### Step 1: List 20 Products

Choose 20 automotive parts from Amar Jyothi Spare Parts or common products:

**Examples:**
- Ceramic brake pads
- Oil filters
- Spark plugs
- Headlight assemblies
- Engine gaskets
- Shock absorbers
- Air filters
- Brake discs
- Clutch plates
- Radiator hoses

### Step 2: Classify Each Product on ICEGATE

Visit: https://www.icegate.gov.in/

For each product:
1. Search by product name/description
2. Find the most specific HS code (8-10 digits preferred)
3. Read the official description
4. Document your reasoning

### Step 3: Fill test_dataset.csv

Open `test_dataset.csv` and add your 20 products:

**Column Definitions:**

| Column | Description | Example |
|--------|-------------|---------|
| `product_name` | Short product name | "Ceramic brake pads" |
| `product_description` | Detailed description | "Ceramic brake pads for motorcycles, finished product, 60% ceramic..." |
| `material` | Material composition | "60% ceramic composite, 30% copper, 10% organic binders" |
| `condition` | Product state | "Finished" / "Raw" / "Component" |
| `function` | Primary function/use | "Braking/friction" |
| `hs_code` | HS code from ICEGATE | "8708.30.10" |
| `hs_description` | Official description | "Brakes and servo-brakes; parts thereof - Mounted brake linings" |
| `reasoning` | Why this code? | "Chapter 87 for vehicle parts, 8708 for accessories, .30 for brakes..." |

**Tips:**
- Be as detailed as possible in descriptions
- Include material percentages if known
- Document your thought process in reasoning
- Use quotes `"like this"` if description contains commas

---

## Phase 0 - Days 3-4: Process & Import Data

### Step 1: Run the Processing Script

```bash
cd data
python scraper.py
```

**What it does:**
1. ‚úÖ Reads `test_dataset.csv`
2. ‚úÖ Validates HS code formats
3. ‚úÖ Extracts keywords from descriptions
4. ‚úÖ Parses HS code hierarchy (chapter/heading/subheading)
5. ‚úÖ Determines parent codes
6. ‚úÖ Structures data matching Prisma schema
7. ‚úÖ Saves to `hs_codes_seed.json`

**Expected output:**
```
üöÄ HS Code Data Processing Script
üìñ Reading CSV from: test_dataset.csv
‚úÖ Loaded 20 rows
üìä Columns: product_name, product_description, ...

üîÑ Structuring 20 records for database import...
‚úì Row 1: 8708.30.10 - 12 keywords extracted
‚úì Row 2: 8708.99.10 - 10 keywords extracted
...

üìä SUMMARY STATISTICS
Total records: 20
Records by chapter:
  Chapter 87: 18 codes
  Chapter 84: 2 codes

üíæ Saving to: hs_codes_seed.json
‚úÖ SUCCESS! Data processing complete.
```

### Step 2: Review Generated JSON

Open `hs_codes_seed.json` to verify:

```json
[
  {
    "code": "8708.30.10",
    "chapter": "87",
    "heading": "8708",
    "subheading": "8708.30",
    "countryCode": "IN",
    "description": "Brakes and servo-brakes; parts thereof - Mounted brake linings - Ceramic brake pads...",
    "keywords": ["ceramic", "brake", "pads", "motorcycles", "finished", "composite"],
    "commonProducts": ["ceramic brake pads"],
    "parentCode": "8708.30"
  },
  ...
]
```

### Step 3: Create Prisma Seed File

Create `backend/prisma/seed.ts`:

```typescript
import { PrismaClient } from '@prisma/client';
import * as fs from 'fs';
import * as path from 'path';

const prisma = new PrismaClient();

async function main() {
  // Read JSON file
  const dataPath = path.join(__dirname, '../../data/hs_codes_seed.json');
  const data = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));

  console.log(`Importing ${data.length} HS codes...`);

  // Import each record
  for (const record of data) {
    await prisma.hsCode.create({
      data: {
        code: record.code,
        chapter: record.chapter,
        heading: record.heading,
        subheading: record.subheading,
        countryCode: record.countryCode,
        description: record.description,
        keywords: record.keywords,
        commonProducts: record.commonProducts,
        parentCode: record.parentCode
      }
    });
  }

  console.log('‚úÖ Database seeded successfully!');
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

Update `backend/package.json`:
```json
{
  "scripts": {
    "prisma:seed": "ts-node prisma/seed.ts"
  },
  "prisma": {
    "seed": "ts-node prisma/seed.ts"
  }
}
```

### Step 4: Import to Database

```bash
cd backend

# Make sure DATABASE_URL is set in .env
# Make sure Prisma schema is applied
npm run prisma:push

# Run seed
npm run prisma:seed
```

### Step 5: Verify Import

```bash
npm run prisma:studio
```

Or query directly:
```sql
SELECT COUNT(*) FROM hs_codes;
SELECT * FROM hs_codes WHERE chapter = '87' LIMIT 5;
```

---

## Script Functions Reference

### `validate_hs_code(code: str) -> bool`
Validates HS code format (4, 6, 8, or 10 digits with optional dots)

**Valid formats:**
- `8708`
- `8708.30`
- `8708.30.10`
- `8708.30.10.00`

### `extract_keywords(description: str) -> List[str]`
Extracts keywords from text:
1. Converts to lowercase
2. Removes punctuation
3. Removes stopwords (the, a, an, etc.)
4. Returns unique keywords

### `parse_hs_code(code: str) -> Dict`
Parses HS code into hierarchy:
```python
parse_hs_code("8708.30.10")
# Returns:
{
  'chapter': '87',
  'heading': '8708',
  'subheading': '8708.30'
}
```

### `determine_parent_code(code: str) -> Optional[str]`
Determines parent in hierarchy:
- `8708.30.10` ‚Üí parent: `8708.30`
- `8708.30` ‚Üí parent: `8708`
- `8708` ‚Üí parent: `None`

### `structure_for_db(df: DataFrame) -> List[Dict]`
Main function that converts CSV to JSON matching Prisma schema

---

## Data Validation

The script validates:

‚úÖ **HS Code Format**
- Must be 4-10 digits
- Optional dots between segments
- Pattern: `XXXX.XX.XX.XX`

‚úÖ **Required Fields**
- `hs_code`: Must be present and valid
- `hs_description`: Falls back to product_description if missing

‚úÖ **Data Quality**
- Removes duplicate keywords
- Handles missing/null values gracefully
- Skips invalid records (with warning)

---

## Troubleshooting

### Error: "CSV file not found"
**Solution:** Make sure you're running from the `data/` directory or check the file path

### Error: "Invalid HS code format"
**Solution:** Check your HS codes in CSV. Valid formats:
- ‚úÖ `8708.30.10`
- ‚úÖ `8708.30`
- ‚úÖ `870830`
- ‚ùå `87-08-30` (hyphens not allowed)
- ‚ùå `8708.3` (incomplete)

### No keywords extracted
**Solution:** Add more details to `product_description` column. The more descriptive text, the better keyword extraction.

### Duplicate HS codes
**Solution:** This is OK! Same code can have multiple product variants. The database will store them as separate records.

---

## Expanding Beyond 20 Products (Phase 1)

Once you've validated the 20-product dataset:

1. **Collect more automotive HS codes** (target: 200-300)
2. **Scrape from ICEGATE** or government HS code lists
3. **Add to CSV** following the same format
4. **Re-run scraper** to generate updated JSON
5. **Re-seed database** with expanded dataset

---

## Example: Complete Workflow

```bash
# 1. Fill CSV with your 20 products
# (Edit test_dataset.csv in Excel/Sheets)

# 2. Install dependencies
pip install pandas

# 3. Run processing script
python scraper.py

# 4. Check output
cat hs_codes_seed.json

# 5. Move to backend and seed database
cd ../backend
npm run prisma:seed

# 6. Verify in Prisma Studio
npm run prisma:studio
```

---

## Future Enhancements (Post-MVP)

- [ ] Web scraper for ICEGATE (automated data collection)
- [ ] Bulk CSV import for 1000+ codes
- [ ] Duplicate detection and merging
- [ ] Keyword quality scoring
- [ ] Automatic categorization (Automotive vs Machinery vs Electronics)
- [ ] Country mapping data (India ‚Üí USA/EU/UK codes)

---

**Last Updated:** November 21, 2024
