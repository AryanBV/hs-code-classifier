// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// Table 1: HS Codes Master Data
// ========================================
model HsCode {
  id               Int      @id @default(autoincrement())
  code             String   @unique @db.VarChar(20) // "0101.21.00"
  description      String   @db.Text // Official description (no duplicate field)
  chapter          String   @db.VarChar(50) // "01"
  heading          String   @db.VarChar(50) // "0101.21"
  subheading       String?  @db.VarChar(50) // "0101.21.00"
  countryCode      String   @default("IN") @map("country_code") @db.VarChar(2)
  dutyRate         String?  @map("duty_rate") @db.VarChar(50) // "10%"
  keywords         String[] // ["brake", "pad", "ceramic"]
  commonProducts   String[] @map("common_products") // ["Ceramic brake pads", ...]
  synonyms         String[] // ["brake pads", "brake linings"]
  exportPolicy     String?  @map("export_policy") @db.VarChar(50) // "Free", "Restricted", "Prohibited"
  notes            Json?    // JSONB field for all extracted PDF notes
  embedding        Unsupported("vector(1536)")? // pgvector for semantic search - requires extension

  // Hierarchy helpers
  isOther          Boolean  @default(false) @map("is_other") // True if description contains "Other"
  parentHeading    String?  @map("parent_heading") @db.VarChar(50) // Link to parent for hierarchy

  // Metadata
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Indexes for fast lookup
  @@index([code], name: "idx_code")
  @@index([chapter], name: "idx_chapter")
  @@index([heading], name: "idx_heading")
  @@index([exportPolicy], name: "idx_export_policy")
  @@index([countryCode], name: "idx_country_code")
  // Vector index - requires pgvector extension
  // Note: This syntax may need adjustment based on Prisma version
  // Alternative: Add via raw SQL migration if not supported
  @@map("hs_codes")
}

// ========================================
// Table 2: HS Code Hierarchy
// ========================================
model HsCodeHierarchy {
  code          String   @id @db.VarChar(20) // HS code (e.g., "8408", "8408.20", "8408.20.10")
  parentCode    String?  @map("parent_code") @db.VarChar(20) // Parent code (e.g., "8408.20" -> parent is "8408")
  level         Int      // Hierarchy level: 2=chapter, 4=heading, 6=subheading, 8/10=tariff
  childrenCodes String[] @map("children_codes") // Array of direct child codes
  allChildren   String[] @map("all_children") // Array of ALL descendant codes (recursive)

  // Metadata
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Indexes for fast hierarchy traversal
  @@index([parentCode], name: "idx_parent_code")
  @@index([level], name: "idx_hierarchy_level")
  @@map("hs_code_hierarchy")
}

// ========================================
// Table 3: Product Synonyms
// ========================================
model ProductSynonym {
  id            Int      @id @default(autoincrement())
  canonicalTerm String   @map("canonical_term") @db.VarChar(200) // "antifreeze"
  synonyms      String[] // ["coolant", "engine coolant", ...]
  hsCode        String   @map("hs_code") @db.VarChar(20) // "3820.00.00"
  category      String   @db.VarChar(100) // "Automotive Fluids"
  confidence    Float    @default(1.0) // 0.0-1.0

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([canonicalTerm], name: "idx_canonical_term")
  @@index([hsCode], name: "idx_synonym_hs_code")
  @@map("product_synonyms")
}

// ========================================
// Table 4: User Classifications
// ========================================
model UserClassification {
  id                     Int       @id @default(autoincrement())
  sessionId              String?   @map("session_id") @db.VarChar(100)
  productDescription     String    @map("product_description") @db.Text
  categoryDetected       String?   @map("category_detected") @db.VarChar(100)
  questionnaireAnswers   Json?     @map("questionnaire_answers") // JSONB in PostgreSQL
  suggestedHsCode        String?   @map("suggested_hs_code") @db.VarChar(20)
  confidenceScore        Int?      @map("confidence_score") // 0-100
  countryCode            String?   @map("country_code") @db.VarChar(2)
  userFeedback           String?   @map("user_feedback") @db.VarChar(20) // "correct", "incorrect", "unsure"
  correctedCode          String?   @map("corrected_code") @db.VarChar(20)
  createdAt              DateTime  @default(now()) @map("created_at")

  // Indexes
  @@index([sessionId], name: "idx_session")
  @@index([suggestedHsCode], name: "idx_suggested_code")
  @@index([categoryDetected], name: "idx_category")
  @@index([createdAt], name: "idx_created_at")
  @@map("user_classifications")
}

// ========================================
// Table 5: Country Mappings
// ========================================
model CountryMapping {
  id                   Int      @id @default(autoincrement())
  indiaCode            String   @map("india_code") @db.VarChar(20)
  country              String   @db.VarChar(50)
  localCode            String   @map("local_code") @db.VarChar(20)
  importDutyRate       String?  @map("import_duty_rate") @db.VarChar(50)
  specialRequirements  String?  @map("special_requirements") @db.Text
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Indexes
  @@index([indiaCode], name: "idx_india_code")
  @@index([country], name: "idx_country")
  @@unique([indiaCode, country], name: "unique_india_code_country")
  @@map("country_mappings")
}

// ========================================
// Table 6: Classification Feedback
// ========================================
model ClassificationFeedback {
  id                   Int      @id @default(autoincrement())
  classificationId     String?  @map("classification_id") @db.VarChar(100) // Unique search ID
  sessionId            String?  @map("session_id") @db.VarChar(100)
  productDescription   String   @map("product_description") @db.Text
  suggestedCode        String   @map("suggested_code") @db.VarChar(20)
  suggestedChapter     String?  @map("suggested_chapter") @db.VarChar(2)
  confidence           Float    // AI confidence score 0.0-100.0

  rating               Int?     // 1-5 stars
  userFeedback         String?  @map("user_feedback") @db.VarChar(20) // "correct", "incorrect", "partial", "unsure"
  userCorrectedCode    String?  @map("user_corrected_code") @db.VarChar(20)
  correctedChapter     String?  @map("corrected_chapter") @db.VarChar(2)
  feedbackNotes        String?  @map("feedback_notes") @db.Text

  classificationMethod String?  @map("classification_method") @db.VarChar(50) // "keyword", "vector", "decision_tree", "ai"
  countryCode          String?  @map("country_code") @db.VarChar(2) @default("IN")

  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Indexes for analytics queries
  @@index([classificationId], name: "idx_feedback_classification_id")
  @@index([suggestedCode], name: "idx_feedback_suggested_code")
  @@index([userCorrectedCode], name: "idx_feedback_corrected_code")
  @@index([rating], name: "idx_feedback_rating")
  @@index([createdAt], name: "idx_feedback_created")
  @@index([countryCode], name: "idx_feedback_country_code")
  @@map("classification_feedback")
}

// ========================================
// Table 7: Classification Conversations
// ========================================
// Stores multi-turn conversations for clarifying questions
model ClassificationConversation {
  id                 String   @id @default(cuid())
  sessionId          String   @map("session_id") @db.VarChar(100)
  productDescription String   @map("product_description") @db.Text

  // Conversation status: active, completed, abandoned
  status             String   @default("active") @db.VarChar(20)

  // Final classification result (populated when completed)
  finalHsCode        String?  @map("final_hs_code") @db.VarChar(20)
  finalConfidence    Float?   @map("final_confidence")
  finalReasoning     String?  @map("final_reasoning") @db.Text
  finalDescription   String?  @map("final_description") @db.Text

  // Tracking metrics
  totalQuestions     Int      @default(0) @map("total_questions")
  totalRounds        Int      @default(0) @map("total_rounds")

  // Enhanced query built from original + all answers
  enhancedQuery      String?  @map("enhanced_query") @db.Text

  // Timestamps
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  completedAt        DateTime? @map("completed_at")

  // Relations
  turns              ConversationTurn[]

  // Indexes
  @@index([sessionId], name: "idx_conv_session")
  @@index([status], name: "idx_conv_status")
  @@index([createdAt], name: "idx_conv_created")
  @@index([finalHsCode], name: "idx_conv_final_code")
  @@map("classification_conversations")
}

// ========================================
// Table 8: Conversation Turns (Q&A pairs)
// ========================================
// Each turn is either questions from LLM or final classification
model ConversationTurn {
  id                String   @id @default(cuid())
  conversationId    String   @map("conversation_id")
  turnNumber        Int      @map("turn_number") // 1, 2, 3...

  // Type: "question" or "classification"
  responseType      String   @map("response_type") @db.VarChar(20)

  // If responseType = "question"
  questionContext   String?  @map("question_context") @db.Text // Why asking
  questions         Json?    // [{id, text, options[], allowOther, priority}]

  // If responseType = "classification"
  hsCode            String?  @map("hs_code") @db.VarChar(20)
  hsDescription     String?  @map("hs_description") @db.Text
  confidence        Float?
  reasoning         String?  @db.Text
  alternatives      Json?    // [{code, description, confidence}]

  // User's answers (populated after user responds)
  userAnswers       Json?    @map("user_answers") // {questionId: selectedOption}

  // Performance tracking
  llmModel          String?  @map("llm_model") @db.VarChar(50)
  responseTimeMs    Int?     @map("response_time_ms")
  candidatesFound   Int?     @map("candidates_found")

  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  answeredAt        DateTime? @map("answered_at")

  // Relations
  conversation      ClassificationConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([conversationId], name: "idx_turn_conversation")
  @@index([turnNumber], name: "idx_turn_number")
  @@index([responseType], name: "idx_turn_type")
  @@map("conversation_turns")
}
