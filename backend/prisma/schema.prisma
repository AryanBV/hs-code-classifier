// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl is optional for migrations from pooler connection
  // directUrl = env("DIRECT_URL")
}

// ========================================
// Table 1: HS Codes Master Data
// ========================================
model HsCode {
  id               Int      @id @default(autoincrement())
  code             String   @unique @db.VarChar(20) // "0101.21.00"
  description      String   @db.Text // Official description
  descriptionClean String?  @map("description_clean") @db.Text // Cleaned description
  chapter          String   @db.VarChar(50) // "01"
  heading          String   @db.VarChar(50) // "0101.21"
  subheading       String?  @db.VarChar(50) // "0101.21.00"
  countryCode      String   @default("IN") @map("country_code") @db.VarChar(2)
  dutyRate         String?  @map("duty_rate") @db.VarChar(50) // "10%"
  keywords         String[] // ["brake", "pad", "ceramic"]
  commonProducts   String[] @map("common_products") // ["Ceramic brake pads", ...]
  synonyms         String[] // ["brake pads", "brake linings"]
  embedding        Unsupported("vector(1536)")? // pgvector for semantic search

  // Hierarchy helpers
  isOther          Boolean  @default(false) @map("is_other") // True if description contains "Other"
  parentHeading    String?  @map("parent_heading") @db.VarChar(50) // Link to parent for hierarchy

  // Metadata
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Indexes for fast lookup
  @@index([code], name: "idx_code")
  @@index([chapter], name: "idx_chapter")
  @@index([heading], name: "idx_heading")
  @@index([countryCode], name: "idx_country_code")
  // Vector index - requires pgvector extension
  // Note: This syntax may need adjustment based on Prisma version
  // Alternative: Add via raw SQL migration if not supported
  @@map("hs_codes")
}

// ========================================
// Table 2: Product Synonyms
// ========================================
model ProductSynonym {
  id            Int      @id @default(autoincrement())
  canonicalTerm String   @map("canonical_term") @db.VarChar(200) // "antifreeze"
  synonyms      String[] // ["coolant", "engine coolant", ...]
  hsCode        String   @map("hs_code") @db.VarChar(20) // "3820.00.00"
  category      String   @db.VarChar(100) // "Automotive Fluids"
  confidence    Float    @default(1.0) // 0.0-1.0

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([canonicalTerm], name: "idx_canonical_term")
  @@index([hsCode], name: "idx_synonym_hs_code")
  @@map("product_synonyms")
}

// ========================================
// Table 3: Decision Trees
// ========================================
model DecisionTree {
  id            Int      @id @default(autoincrement())
  categoryName  String   @unique @map("category_name") @db.VarChar(100)
  decisionFlow  Json     @map("decision_flow") // JSONB in PostgreSQL
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("decision_trees")
}

// ========================================
// Table 4: User Classifications
// ========================================
model UserClassification {
  id                     Int       @id @default(autoincrement())
  sessionId              String?   @map("session_id") @db.VarChar(100)
  productDescription     String    @map("product_description") @db.Text
  categoryDetected       String?   @map("category_detected") @db.VarChar(100)
  questionnaireAnswers   Json?     @map("questionnaire_answers") // JSONB in PostgreSQL
  suggestedHsCode        String?   @map("suggested_hs_code") @db.VarChar(20)
  confidenceScore        Int?      @map("confidence_score") // 0-100
  countryCode            String?   @map("country_code") @db.VarChar(2)
  userFeedback           String?   @map("user_feedback") @db.VarChar(20) // "correct", "incorrect", "unsure"
  correctedCode          String?   @map("corrected_code") @db.VarChar(20)
  createdAt              DateTime  @default(now()) @map("created_at")

  // Indexes
  @@index([sessionId], name: "idx_session")
  @@index([suggestedHsCode], name: "idx_suggested_code")
  @@index([categoryDetected], name: "idx_category")
  @@index([createdAt], name: "idx_created_at")
  @@map("user_classifications")
}

// ========================================
// Table 5: Country Mappings
// ========================================
model CountryMapping {
  id                   Int      @id @default(autoincrement())
  indiaCode            String   @map("india_code") @db.VarChar(20)
  country              String   @db.VarChar(50)
  localCode            String   @map("local_code") @db.VarChar(20)
  importDutyRate       String?  @map("import_duty_rate") @db.VarChar(50)
  specialRequirements  String?  @map("special_requirements") @db.Text
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Indexes
  @@index([indiaCode], name: "idx_india_code")
  @@index([country], name: "idx_country")
  @@unique([indiaCode, country], name: "unique_india_code_country")
  @@map("country_mappings")
}

// ========================================
// Table 6: Classification Feedback
// ========================================
model ClassificationFeedback {
  id                   Int      @id @default(autoincrement())
  sessionId            String?  @map("session_id") @db.VarChar(100)
  productDescription   String   @map("product_description") @db.Text
  suggestedCode        String   @map("suggested_code") @db.VarChar(20)
  confidence           Float    // AI confidence score 0.0-1.0
  userFeedback         String   @map("user_feedback") @db.VarChar(20) // "correct", "incorrect", "unsure"
  correctedCode        String?  @map("corrected_code") @db.VarChar(20)
  feedbackNotes        String?  @map("feedback_notes") @db.Text
  
  createdAt            DateTime @default(now()) @map("created_at")

  @@index([suggestedCode], name: "idx_feedback_suggested_code")
  @@index([userFeedback], name: "idx_user_feedback")
  @@index([createdAt], name: "idx_feedback_created")
  @@map("classification_feedback")
}
